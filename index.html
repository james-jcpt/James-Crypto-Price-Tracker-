<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCI Platform</title>
<style>
  body { font-family: Arial,sans-serif; background:#121212; color:#fff; margin:0; padding:0; }
  header { background:#1f1f1f; padding:15px 20px; text-align:center; font-size:28px; font-weight:bold; }
  #app { padding:20px; max-width:1000px; margin:auto; }
  select, button { padding:8px 12px; margin:5px; font-size:16px; border-radius:5px; border:none; cursor:pointer; }
  #coin-chart, #rsi-chart { width:100%; margin-bottom:20px; }
  #coin-chart { height:400px; }
  #rsi-chart { height:100px; }
  h2 { margin-top:20px; }
  .news-item { margin:10px 0; padding:10px; background:#1f1f1f; border-radius:8px; }
  .news-item img { max-width:100%; border-radius:5px; margin-top:5px; }
</style>
</head>
<body>

<header>JCI Platform</header>
<div id="app">

  <!-- Coin Selector -->
  <select id="coin-select">
    <option value="bitcoin">Bitcoin</option>
    <option value="ethereum">Ethereum</option>
    <option value="dogecoin">Dogecoin</option>
  </select>

  <!-- Candlestick Chart -->
  <div id="coin-chart"></div>
  <div id="rsi-chart"></div>

  <!-- News -->
  <h2>Crypto News</h2>
  <div id="news"></div>

  <!-- Leaderboard -->
  <h2>Leaderboard</h2>
  <div id="leaderboard"></div>

  <!-- Premium Subscription -->
  <h2>Premium Subscription</h2>
  <button id="subscribe-btn">Subscribe</button>

  <!-- Login / Signup -->
  <h2>Login / Signup</h2>
  <button id="login-btn">Login</button>
  <button id="signup-btn">Signup</button>

</div>

<!-- Lightweight Charts Library -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script type="module">

// ---------------- Firebase ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMWmtgufykRj0ExqXQYsp6aGEsf7-EzxM",
  authDomain: "jci-platform.firebaseapp.com",
  projectId: "jci-platform",
  storageBucket: "jci-platform.firebasestorage.app",
  messagingSenderId: "455825874162",
  appId: "1:455825874162:web:a667b64a5b2fc276e6846b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Login / Signup
document.getElementById('login-btn').addEventListener('click', async () => {
  const email = prompt("Email:");
  const password = prompt("Password:");
  try { await signInWithEmailAndPassword(auth, email, password); alert("Logged in!"); }
  catch(e){ alert(e.message); }
});

document.getElementById('signup-btn').addEventListener('click', async () => {
  const email = prompt("Email:");
  const password = prompt("Password:");
  try { 
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db,"users",userCred.user.uid),{ email, premium:false, premium_expiry:null });
    alert("Account created!"); 
  } catch(e){ alert(e.message); }
});

// ---------------- Chart ----------------
const chartDiv = document.getElementById('coin-chart');
const rsiDiv = document.getElementById('rsi-chart');
let coin = 'bitcoin';
const apiKey = 'CG-CYH731sjKeHka2Gzp2mWW4DL';

const chart = LightweightCharts.createChart(chartDiv, {
  width: chartDiv.clientWidth, height: 400,
  layout: { background: { color: '#121212' }, textColor: '#fff' },
  grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
  rightPriceScale: { borderColor: '#555' },
  timeScale: { borderColor: '#555' }
});

const candleSeries = chart.addCandlestickSeries();
const ma7 = chart.addLineSeries({ color: '#FFA500', lineWidth: 2 });
const ma25 = chart.addLineSeries({ color: '#FF00FF', lineWidth: 2 });
const ma99 = chart.addLineSeries({ color: '#00FFFF', lineWidth: 2 });
const volumeSeries = chart.addHistogramSeries({ color:'#26a69a', priceFormat:{type:'volume'}, scaleMargins:{top:0.8,bottom:0} });

const rsiChart = LightweightCharts.createChart(rsiDiv, { width:rsiDiv.clientWidth, height:100,
  layout:{ background:{color:'#121212'}, textColor:'#fff' },
  grid:{ vertLines:{color:'#333'}, horzLines:{color:'#333'} },
  rightPriceScale:{ borderColor:'#555' }, timeScale:{ borderColor:'#555' }});
const rsiSeries = rsiChart.addLineSeries({ color:'#FF0000', lineWidth:2 });

async function fetchCandleData(coinId){
  const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/ohlc?vs_currency=usd&days=1&x_cg_pro_api_key=${apiKey}`);
  const data = await res.json();
  const candles = data.map(d=>({time:d[0]/1000, open:d[1], high:d[2], low:d[3], close:d[4]}));
  const volumes = data.map(d=>({time:d[0]/1000, value:d[4]-d[1], color:d[4]>d[1]?'#26a69a':'#ef5350'}));
  const closes = data.map(d=>d[4]);
  const rsiData = calculateRSI(closes,14).map((v,i)=>({time:data[i][0]/1000, value:v}));
  return {candles, volumes, rsiData};
}

function calculateRSI(closes, period){
  let gains=[], losses=[], rsi=[];
  for(let i=1;i<closes.length;i++){ let change=closes[i]-closes[i-1]; gains.push(change>0?change:0); losses.push(change<0?-change:0);}
  for(let i=0;i<gains.length;i++){ if(i<period){ rsi.push(50); continue; } let avgGain=gains.slice(i-period+1,i+1).reduce((a,b)=>a+b,0)/period;
    let avgLoss=losses.slice(i-period+1,i+1).reduce((a,b)=>a+b,0)/period; rsi.push(avgLoss===0?100:100-(100/(1+avgGain/avgLoss))); }
  return rsi;
}

function calculateMA(closes, period){ return closes.map((v,i)=>i<period?v:closes.slice(i-period+1,i+1).reduce((a,b)=>a+b,0)/period); }

async function updateChart(){
  const {candles, volumes, rsiData} = await fetchCandleData(coin);
  candleSeries.setData(candles);
  volumeSeries.setData(volumes);
  rsiSeries.setData(rsiData);

  const closes = candles.map(c=>c.close);
  ma7.setData(calculateMA(closes,7).map((v,i)=>({time:candles[i].time,value:v})));
  ma25.setData(calculateMA(closes,25).map((v,i)=>({time:candles[i].time,value:v})));
  ma99.setData(calculateMA(closes,99).map((v,i)=>({time:candles[i].time,value:v})));
}

document.getElementById('coin-select').addEventListener('change', e=>{ coin=e.target.value; updateChart(); });
updateChart();
setInterval(updateChart,5000);

// ---------------- News ----------------
async function fetchNews(){
  const res = await fetch(`https://api.coingecko.com/api/v3/status_updates?category=general&per_page=5&page=1&x_cg_pro_api_key=${apiKey}`);
  const newsData = await res.json();
  const container = document.getElementById('news');
  container.innerHTML='';
  newsData.status_updates.forEach(item=>{
    const div = document.createElement('div');
    div.className='news-item';
    div.innerHTML=`<strong>${item.project?.name||'Crypto'}</strong>
                   <p>${item.description}</p>
                   ${item.image?`<img src="${item.image}" />`:''}`;
    container.appendChild(div);
  });
}
fetchNews();
setInterval(fetchNews,60000);

// ---------------- Leaderboard ----------------
const leaderboard = document.getElementById('leaderboard');
const users = [ {name:'Alice', points:120}, {name:'Bob', points:110}, {name:'Charlie', points:100} ];
function updateLeaderboard(){ leaderboard.innerHTML = users.sort((a,b)=>b.points-a.points).map(u=>`<p>${u.name}: ${u.points} pts</p>`).join(''); }
updateLeaderboard();

// ---------------- Flutterwave Premium ----------------
document.getElementById('subscribe-btn').addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user) { alert("Login first!"); return; }

    const paymentUrl = `https://flutterwave.com/pay/auqlm2umyaq9?meta[userId]=${user.uid}&meta[plan]=monthly`;
    window.open(paymentUrl,"_blank","width=600,height=800");

    const userDoc = doc(db,"users",user.uid);
    const unsubscribe = onSnapshot(userDoc, docSnap => {
        if(docSnap.exists() && docSnap.data().premium){
            alert("ðŸŽ‰ Your account is now Premium!");
            unsubscribe();
        }
    });
});

</script>

</body>
  </html>
